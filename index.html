<!doctype html>
<html lang="nb">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Breakout for Bjørnar – Tippekupong-stemning</title>
<style>
  :root{
    --bg:#0d1117; --panel:#161b22; --ink:#e6edf3; --muted:#9fb1d1;
    --line:#30363d; --pepsi:#1e2a78; --cola:#b30000;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,Segoe UI,Roboto,Arial}
  body{overflow:hidden} /* ingen scrolling */
  header{height:54px;display:flex;align-items:center;gap:10px;justify-content:center;
         background:var(--panel);border-bottom:1px solid var(--line);padding:6px 10px}
  h1{margin:0;font-size:16px}
  .hud{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center}
  .stat{background:#10151d;border:1px solid var(--line);padding:6px 10px;border-radius:10px;min-width:96px;text-align:center}
  .stat b{font-size:18px}
  .btns{display:flex;gap:6px;flex-wrap:wrap}
  button{cursor:pointer;border:1px solid var(--line);background:#0f1622;color:var(--ink);padding:8px 10px;border-radius:10px;font-weight:600}
  button:hover{border-color:#445}
  #stage{height:calc(100vh - 54px);display:flex;flex-direction:column;align-items:center;justify-content:flex-start}
  #canvasWrap{position:relative;transform-origin:top center;}
  canvas{display:block;background:linear-gradient(180deg,#0b1220,#0a0f18);border-radius:12px;border:1px solid #112}
  .msg{height:28px;display:flex;align-items:center;justify-content:center;margin-top:4px;font-weight:700}
  .msg .soda{padding:2px 8px;border-radius:999px;margin:0 4px;color:#fff}
  .soda.pepsi{background:var(--pepsi)}
  .soda.cola{background:var(--cola)}
  .touch{display:none;gap:8px;justify-content:center;margin-top:6px}
  .touch button{width:120px}
  @media (pointer:coarse){
    .touch{display:flex}
  }
</style>
</head>
<body>
<header>
  <h1>Breakout for Bjørnar</h1>
  <div class="hud">
    <div class="stat">Poeng<br><b id="score">0</b></div>
    <div class="stat">Level<br><b id="level">1</b></div>
    <div class="stat">Liv<br><b id="lives">3</b></div>
  </div>
  <div class="btns">
    <button id="btnStart">Start</button>
    <button id="btnPause">Pause</button>
    <button id="btnSound">Lyd: Av</button>
    <button id="btnSpeak">Tale: På</button>
  </div>
</header>

<div id="stage" aria-live="polite">
  <div id="canvasWrap">
    <!-- Intern logikk tegner i 800x520; vi skalerer visuelt for å passe i vinduet -->
    <canvas id="game" width="800" height="520" aria-label="Breakout-brett"></canvas>
    <!-- Pepsi/Cola dekorbånd -->
    <canvas id="ribbon" width="800" height="16" style="position:absolute;left:0;top:0;pointer-events:none"></canvas>
  </div>
  <div class="touch">
    <button id="leftBtn">◀ Venstre</button>
    <button id="rightBtn">Høyre ▶</button>
  </div>
  <div id="feedback" class="msg"></div>
</div>

<script>
(()=>{
  // ---- Konstanter ----
  const SPILL = ["Lotto","Vikinglotto","Nabolaget","Eurojackpot","Extra","Joker","Keno"];

  // Oppmuntringer – alle inkluderer "Bjørnar"
  const PRAISE = [
    "Bjørnar, du er like kul som en tippekupong!",
    "Bjørnar, for et treff! Pepsi Max-presisjon!",
    "Bjørnar, Cola-kraft! Den satt!",
    "Bjørnar, oddsen er på din side!",
    "Bjørnar, dette er mesterlig kontroll!",
    "Bjørnar, ren klasse!",
    "Bjørnar, kupongen din går rett inn!",
    "Bjørnar, helt nydelig spill!",
    "Bjørnar, du eier brettet!",
    "Bjørnar, vinnerflyt!"
  ];
  let praiseBag = shuffle([...PRAISE]);
  const nextPraise = () => (praiseBag.length? praiseBag: (praiseBag = shuffle([...PRAISE]))).pop();

  // ---- DOM / Canvas ----
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const ribbon = document.getElementById('ribbon');
  const rctx = ribbon.getContext('2d');
  const wrap = document.getElementById('canvasWrap');

  const scoreEl = document.getElementById('score');
  const levelEl = document.getElementById('level');
  const livesEl = document.getElementById('lives');
  const feedback = document.getElementById('feedback');

  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnSound = document.getElementById('btnSound');
  const btnSpeak = document.getElementById('btnSpeak');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');

  const BASE_W = 800, BASE_H = 520;

  // ---- Lyd & Tale ----
  let audioCtx, soundOn = false;
  let speakOn = true;
  function tone(freq=880, dur=0.06){
    if(!soundOn) return;
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type='square'; o.frequency.value=freq; g.gain.value=0.07;
    o.connect(g); g.connect(audioCtx.destination); o.start();
    setTimeout(()=>o.stop(), dur*1000);
  }
  function say(text){
    if(!speakOn || !('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'nb-NO'; u.rate = 1.02; u.pitch = 1.0; u.volume = 1.0;
    // Ikke avbryt hvis det nettopp snakker; la korte klipp køes
    window.speechSynthesis.speak(u);
  }

  // ---- Spilltilstand ----
  let score=0, lives=3, level=1, paused=false, running=false;
  const paddle = { w: 110, h: 14, x: (BASE_W-110)/2, y: BASE_H-30, speed: 8, dx:0 };
  const ball = { x: BASE_W/2, y: BASE_H-60, r: 8, dx:4, dy:-4, speedMul:1 };

  let rows=5, cols=10, gap=6, brickH=22, bricks=[], colors=["#58a6ff","#39d353","#ff7b72","#d2a8ff","#f2cc60","#8b949e","#7ee787"];

  // Periodisk personlig oppmuntring
  let lastCheer = 0;
  const CHEER_INTERVAL = 5000; // minst hvert 5. sekund

  function resetBall(){
    ball.x = paddle.x + paddle.w/2;
    ball.y = paddle.y - 12;
    const angle = (Math.random()*0.6 + 0.2) * Math.PI; // 36–144°
    const speed = 5 + level*0.5;
    ball.dx = Math.cos(angle) * (Math.random()<0.5? -speed : speed);
    ball.dy = -Math.abs(Math.sin(angle) * speed);
  }

  function buildBricks(){
    bricks = [];
    const totalGapX = (cols+1)*gap;
    const bw = Math.floor((BASE_W - totalGapX)/cols);
    const top = 80;
    let i=0;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const x = gap + c*(bw+gap);
        const y = top + r*(brickH+gap);
        const label = SPILL[i % SPILL.length]; i++;
        bricks.push({x,y,w:bw,h:brickH,alive:true,color:colors[r%colors.length],label});
      }
    }
  }

  function roundRect(ctx,x,y,w,h,r,fill=true){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    if(fill) ctx.fill();
  }

  function drawRibbon(){
    rctx.clearRect(0,0,BASE_W,16);
    rctx.fillStyle = "#1e2a78"; rctx.fillRect(0,0,BASE_W,8);   // Pepsi Max
    rctx.fillStyle = "#b30000"; rctx.fillRect(0,8,BASE_W,8);   // Cola
  }

  function draw(){
    ctx.clearRect(0,0,BASE_W,BASE_H);
    // bricks
    ctx.font = "12px system-ui,Segoe UI,Roboto,Arial";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    bricks.forEach(b=>{
      if(!b.alive) return;
      ctx.fillStyle = b.color; roundRect(ctx,b.x,b.y,b.w,b.h,6);
      ctx.fillStyle = "#0b1020"; ctx.fillText(b.label, b.x + b.w/2, b.y + b.h/2);
    });
    // paddle
    ctx.fillStyle="#0ef"; roundRect(ctx,paddle.x,paddle.y,paddle.w,paddle.h,8);
    // ball
    const g = ctx.createRadialGradient(ball.x-3,ball.y-3,2,ball.x,ball.y,12);
    g.addColorStop(0,"#fff"); g.addColorStop(1,"#58a6ff");
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2); ctx.fill();
  }

  function update(ts){
    if(paused || !running) return;

    // Periodisk heiarop med navn
    if(!lastCheer) lastCheer = ts;
    if(ts - lastCheer >= CHEER_INTERVAL){
      say(nextPraise());
      lastCheer = ts;
    }

    // paddle
    paddle.x += paddle.dx;
    paddle.x = Math.max(0, Math.min(BASE_W - paddle.w, paddle.x));

    // ball
    ball.x += ball.dx * ball.speedMul;
    ball.y += ball.dy * ball.speedMul;

    // vegger
    if(ball.x - ball.r < 0){ ball.x = ball.r; ball.dx*=-1; tone(500); }
    if(ball.x + ball.r > BASE_W){ ball.x = BASE_W - ball.r; ball.dx*=-1; tone(520); }
    if(ball.y - ball.r < 0){ ball.y = ball.r; ball.dy*=-1; tone(540); }

    // paddle-kollisjon
    if(ball.y + ball.r >= paddle.y && ball.y + ball.r <= paddle.y + paddle.h &&
       ball.x >= paddle.x && ball.x <= paddle.x + paddle.w && ball.dy>0){
      const hit = (ball.x - (paddle.x + paddle.w/2))/(paddle.w/2);
      const speed = Math.hypot(ball.dx, ball.dy)*1.02;
      const angle = hit * (Math.PI/3);
      ball.dx = speed * Math.sin(angle);
      ball.dy = -Math.abs(speed * Math.cos(angle));
      tone(800,0.05);
      // Liten sjanse for ekstra heiarop ved god treffrytme
      if(Math.random()<0.25) say("Bjørnar, perfekt timing!");
    }

    // brick-kollisjon
    for(const b of bricks){
      if(!b.alive) continue;
      if(ball.x > b.x && ball.x < b.x + b.w && ball.y > b.y && ball.y < b.y + b.h){
        b.alive = false;
        score += 10;
        scoreEl.textContent = score;
        ball.dy *= -1;
        tone(900,0.06);

        // Si navnet på spillet og heie på Bjørnar
        say(`Bjørnar – ${b.label}!`);
        feedback.innerHTML = spice(`${b.label}! ${nextPraise()}`);
        lastCheer = performance.now(); // reset så det ikke kommer to på rappen
        break;
      }
    }

    // liv tapt
    if(ball.y - ball.r > BASE_H){
      lives--; livesEl.textContent = lives; tone(200,0.2);
      if(lives<=0){
        feedback.innerHTML = spice("Game over – Bjørnar, ny runde snart!");
        say("Bjørnar, ny runde – du tar den neste!");
        running=false;
      } else {
        feedback.innerHTML = spice("Ny ball! Fokus, Bjørnar!");
        say("Bjørnar, ny ball – på'n igjen!");
        resetBall();
      }
    }

    // level clear
    if(bricks.every(b=>!b.alive)){
      level++; levelEl.textContent = level;
      rows = Math.min(8, rows+1);
      ball.speedMul += 0.05;
      feedback.innerHTML = spice(`Level ${level}! Cola-rakett!`);
      say(`Bjørnar – level ${level}!`);
      buildBricks(); resetBall();
    }
  }

  function loop(ts){
    draw(); update(ts||0);
    requestAnimationFrame(loop);
  }

  // ---- Input ----
  document.addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft' || e.key==='a' || e.key==='A'){ paddle.dx = -paddle.speed; e.preventDefault(); }
    if(e.key==='ArrowRight'|| e.key==='d' || e.key==='D'){ paddle.dx =  paddle.speed; e.preventDefault(); }
    if(e.key===' '){ paused = !paused; feedback.textContent = paused?"Pause":"Spill i gang!"; }
  });
  document.addEventListener('keyup', e=>{
    if(['ArrowLeft','a','A','ArrowRight','d','D'].includes(e.key)){ paddle.dx = 0; }
  });
  // Touch
  const touchable = matchMedia('(pointer:coarse)').matches;
  if(touchable){
    leftBtn.addEventListener('touchstart', e=>{ paddle.dx=-paddle.speed; e.preventDefault(); });
    rightBtn.addEventListener('touchstart', e=>{ paddle.dx= paddle.speed; e.preventDefault(); });
    const stopTouch=()=>{ paddle.dx=0; };
    leftBtn.addEventListener('touchend', stopTouch); rightBtn.addEventListener('touchend', stopTouch);
  }

  // ---- Knappelogikk ----
  btnStart.onclick = ()=>{
    score=0; level=1; lives=3; rows=5; ball.speedMul=1;
    scoreEl.textContent=score; levelEl.textContent=level; livesEl.textContent=lives;
    buildBricks(); resetBall(); running=true; paused=false;
    feedback.textContent = "Kickoff! Kupongen er inne – kjør!";
    say("Bjørnar, nå kjører vi!");
  };
  btnPause.onclick = ()=>{
    if(!running) return;
    paused = !paused;
    feedback.textContent = paused?"Pause":"Tilbake i spill!";
    if(!paused) say("Bjørnar, tilbake i spill!");
  };
  btnSound.onclick = ()=>{ soundOn = !soundOn; btnSound.textContent = "Lyd: " + (soundOn ? "På" : "Av"); if(soundOn) tone(660,0.05); };
  btnSpeak.onclick = ()=>{ speakOn = !speakOn; btnSpeak.textContent = "Tale: " + (speakOn ? "På" : "Av"); if(speakOn) say("Tale aktivert, Bjørnar!"); };

  // ---- Pepsi/Cola spice i tekst ----
  function spice(text){
    const soda = Math.random()<0.5 ? '<span class="soda pepsi">Pepsi&nbsp;Max</span>' : '<span class="soda cola">Cola</span>';
    return text.replace(/Pepsi Max|Pepsi|Cola/gi, ()=>soda);
  }

  // ---- Skaler brettet til 100vh (ingen scroll) ----
  function fitToViewport(){
    const headerH = document.querySelector('header').offsetHeight || 54;
    const stageH = window.innerHeight - headerH - 6; // liten margin
    const stageW = window.innerWidth - 12;
    // Hvilken skala får hele canvas (800x520) til å passe?
    const s = Math.min(stageW / BASE_W, stageH / (BASE_H + 0)); // +0: ribbon ligger oppå
    wrap.style.transform = `scale(${s})`;
    wrap.style.height = (BASE_H) + "px";
    wrap.style.width  = (BASE_W) + "px";
  }
  window.addEventListener('resize', fitToViewport);

  // ---- Init ----
  drawRibbon();
  buildBricks();
  resetBall();
  fitToViewport();
  requestAnimationFrame(loop);

  // ---- Utils ----
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
})();
</script>
</body>
</html>
